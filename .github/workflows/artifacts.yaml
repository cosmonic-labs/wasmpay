name: artifacts

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      # Checkout repository
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      # Environment Setup (Rust, Go, Node, WASM Tooling)
      - name: Setup WASM Build Environment
        uses: ./.github/actions/wash-setup
        with:
          # optional: specify go version file to use.
          go-version-file: go.work
          # optional: specify go cache dependency path to use.
          go-cache-dependency-path: '*/go.sum'

      # WAC/Donut: wasmpay-platform-harness
      # will be used by other components as dependency.
      - name: Build wasmpay-platform-harness
        uses: ./.github/actions/wash-build
        with:
          working-directory: wasmpay-platform-harness

      # Component: API Gateway
      # build static UI so it can be embedded in the wasm binary.
      - name: Build Banking UI
        working-directory: api-gateway/wasmcloud.banking
        run: |
          npm ci
          npm run build --workspaces --if-present

      - name: Build API Gateway
        uses: ./.github/actions/wash-build
        with:
          working-directory: api-gateway

      - name: Push API Gateway
        if: github.ref == 'refs/heads/main'
        uses: ./.github/actions/wash-push
        with:
          working-directory: api-gateway
          registry-username: ${{ github.actor }}
          registry-password: ${{ secrets.GITHUB_TOKEN }}
          artifact: build/api-gateway_s.wasm
          image: ghcr.io/cosmonic-labs/wasmpay/api-gateway:latest

      # Component: Transaction Manager
      - name: Build Transaction Manager
        uses: ./.github/actions/wash-build
        with:
          working-directory: transaction-manager

      - name: Push Transaction Manager
        if: github.ref == 'refs/heads/main'
        uses: ./.github/actions/wash-push
        with:
          working-directory: transaction-manager
          registry-username: ${{ github.actor }}
          registry-password: ${{ secrets.GITHUB_TOKEN }}
          artifact: build/transaction_manager_s.wasm
          image: ghcr.io/cosmonic-labs/wasmpay/transaction-manager:latest

      # Component: wasmpay-validator
      - name: Build wasmpay-validator
        uses: ./.github/actions/wash-build
        with:
          working-directory: wasmpay-validator

      - name: Push wasmpay-validator
        if: github.ref == 'refs/heads/main'
        uses: ./.github/actions/wash-push
        with:
          working-directory: wasmpay-validator
          registry-username: ${{ github.actor }}
          registry-password: ${{ secrets.GITHUB_TOKEN }}
          artifact: build/wasmpay-validator.composed_s.wasm
          image: ghcr.io/cosmonic-labs/wasmpay/wasmpay-validator:latest

      # Component: (Bank) nordhaven-validator
      - name: Build nordhaven-validator
        uses: ./.github/actions/wash-build
        with:
          working-directory: nordhaven-validator

      - name: Push nordhaven-validator
        if: github.ref == 'refs/heads/main'
        uses: ./.github/actions/wash-push
        with:
          working-directory: nordhaven-validator
          registry-username: ${{ github.actor }}
          registry-password: ${{ secrets.GITHUB_TOKEN }}
          artifact: build/nordhaven-validator.composed_s.wasm
          image: ghcr.io/cosmonic-labs/wasmpay/nordhaven-validator:latest

      # Component: (Bank) icamer-validator
      - name: Build icamer-validator
        uses: ./.github/actions/wash-build
        with:
          working-directory: icamer-validator

      - name: Push icamer-validator
        if: github.ref == 'refs/heads/main'
        uses: ./.github/actions/wash-push
        with:
          working-directory: icamer-validator
          registry-username: ${{ github.actor }}
          registry-password: ${{ secrets.GITHUB_TOKEN }}
          artifact: build/icamer_validator.composed_s.wasm
          image: ghcr.io/cosmonic-labs/wasmpay/icamer-validator:latest
